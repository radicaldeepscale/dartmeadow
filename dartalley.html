<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART ALLEY | Aerospace Neural Search</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cyan:    #00e5ff;
            --orange:  #ff6b35;
            --green:   #39ff14;
            --purple:  #c084fc;
            --void:    #020408;
            --panel:   rgba(0,229,255,0.04);
            --panel-b: rgba(0,229,255,0.08);
            --border:  rgba(0,229,255,0.18);
            --text:    #c8d8e8;
            --dim:     #4a6070;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        html{scroll-behavior:smooth;}
        body{font-family:'Exo 2',sans-serif;background:var(--void);color:var(--text);min-height:100vh;overflow-x:hidden;}
        body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,0) 0px,rgba(0,0,0,0) 2px,rgba(0,0,0,0.055) 2px,rgba(0,0,0,0.055) 4px);pointer-events:none;z-index:9999;}
        #sc{position:fixed;inset:0;z-index:0;pointer-events:none;}

        /* CORNER BRACKETS */
        .cnr{position:fixed;width:55px;height:55px;opacity:0.18;pointer-events:none;z-index:2;}
        .cnr.tl{top:16px;left:16px;border-top:2px solid var(--cyan);border-left:2px solid var(--cyan);}
        .cnr.br{bottom:16px;right:16px;border-bottom:2px solid var(--orange);border-right:2px solid var(--orange);}

        .app{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;padding:0 16px 80px;}

        /* HUD */
        .hud{width:100%;max-width:960px;display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:var(--dim);letter-spacing:1px;}
        .hud-l{display:flex;gap:18px;}
        .ind{display:flex;align-items:center;gap:5px;}
        .dot{width:6px;height:6px;border-radius:50%;}
        .dot.g{background:var(--green);box-shadow:0 0 5px var(--green);animation:pd 2s ease-in-out infinite;}
        .dot.o{background:var(--orange);box-shadow:0 0 5px var(--orange);animation:pd 2.5s ease-in-out infinite;}
        @keyframes pd{0%,100%{opacity:1}50%{opacity:0.25}}
        #htime{color:var(--cyan);}

        /* LOGO */
        .logo{margin-top:5vh;text-align:center;margin-bottom:36px;}
        .logo-eye{font-family:'Share Tech Mono',monospace;font-size:0.7rem;letter-spacing:7px;color:var(--orange);text-transform:uppercase;margin-bottom:10px;}
        .logo-main{font-family:'Orbitron',monospace;font-size:clamp(2.4rem,8vw,4.8rem);font-weight:900;letter-spacing:5px;color:#fff;text-transform:uppercase;text-shadow:0 0 40px rgba(0,229,255,0.7),0 0 80px rgba(0,229,255,0.2);animation:breathe 4s ease-in-out infinite;}
        @keyframes breathe{0%,100%{text-shadow:0 0 40px rgba(0,229,255,0.6),0 0 80px rgba(0,229,255,0.2)}50%{text-shadow:0 0 60px rgba(0,229,255,1),0 0 120px rgba(0,229,255,0.4)}}
        .logo-sub{font-family:'Orbitron',monospace;font-size:clamp(0.7rem,2vw,1.05rem);font-weight:400;letter-spacing:10px;color:var(--cyan);text-transform:uppercase;margin-top:8px;opacity:0.8;}
        .logo-line{height:1px;width:260px;margin:16px auto 0;background:linear-gradient(90deg,transparent,var(--cyan),var(--orange),transparent);}

        /* BADGES */
        .badges{display:flex;gap:8px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
        .badge{font-family:'Share Tech Mono',monospace;font-size:0.58rem;letter-spacing:1.5px;padding:4px 10px;border:1px solid var(--border);border-radius:2px;color:var(--dim);display:flex;align-items:center;gap:5px;transition:all 0.3s;}
        .badge.cyan{color:var(--cyan);border-color:rgba(0,229,255,0.4);}
        .badge.orng{color:var(--orange);border-color:rgba(255,107,53,0.4);}
        .badge.purp{color:var(--purple);border-color:rgba(192,132,252,0.4);}
        .bdot{width:5px;height:5px;border-radius:50%;background:currentColor;box-shadow:0 0 4px currentColor;}

        /* SEARCH */
        .sw{width:100%;max-width:700px;}
        .sf{position:relative;border:1px solid var(--border);border-radius:4px;background:var(--panel);backdrop-filter:blur(8px);}
        .sf::before{content:'QUERY INPUT';position:absolute;top:-9px;left:14px;font-family:'Share Tech Mono',monospace;font-size:0.56rem;letter-spacing:2px;color:var(--cyan);background:var(--void);padding:0 6px;}
        .sf::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--cyan),transparent 70%);opacity:0.45;}
        .si{display:flex;align-items:center;padding:6px 8px;}
        .pfx{font-family:'Share Tech Mono',monospace;color:var(--orange);font-size:1rem;padding:0 10px;flex-shrink:0;}
        input[type="text"]{flex:1;padding:12px 8px;font-size:1rem;background:transparent;border:none;color:#fff;outline:none;font-family:'Share Tech Mono',monospace;letter-spacing:0.5px;caret-color:var(--cyan);}
        input::placeholder{color:var(--dim);font-size:0.85rem;}
        .bscan{font-family:'Orbitron',monospace;font-size:0.62rem;font-weight:700;letter-spacing:2px;padding:10px 18px;background:linear-gradient(135deg,var(--cyan),rgba(0,180,220,0.8));color:var(--void);border:none;border-radius:2px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;white-space:nowrap;}
        .bscan:hover{box-shadow:0 0 20px rgba(0,229,255,0.4);transform:translateY(-1px);}
        .bscan:active{transform:translateY(0);}
        .bscan:disabled{opacity:0.45;cursor:not-allowed;transform:none;}

        /* FILTERS */
        .frow{display:flex;gap:7px;margin-top:12px;flex-wrap:wrap;}
        .ft{font-family:'Share Tech Mono',monospace;font-size:0.6rem;letter-spacing:1px;padding:5px 11px;border:1px solid var(--border);border-radius:2px;color:var(--dim);cursor:pointer;transition:all 0.2s;text-transform:uppercase;background:transparent;user-select:none;}
        .ft.on-c{color:var(--cyan);border-color:rgba(0,229,255,0.5);background:rgba(0,229,255,0.05);}
        .ft.on-o{color:var(--orange);border-color:rgba(255,107,53,0.5);background:rgba(255,107,53,0.05);}
        .ft.on-p{color:var(--purple);border-color:rgba(192,132,252,0.5);background:rgba(192,132,252,0.05);}

        /* STATUS */
        .sbar{width:100%;max-width:700px;margin-top:10px;font-family:'Share Tech Mono',monospace;font-size:0.62rem;color:var(--dim);letter-spacing:1px;min-height:20px;display:flex;gap:14px;flex-wrap:wrap;}
        .s2{display:flex;align-items:center;gap:4px;}
        .s2.ok{color:var(--green);}
        .s2.warn{color:var(--orange);}
        .s2.err{color:#ef4444;}

        /* LOADER */
        .lw{display:none;flex-direction:column;align-items:center;gap:14px;margin-top:50px;}
        .radar{width:56px;height:56px;border-radius:50%;border:2px solid var(--border);border-top-color:var(--cyan);border-right-color:var(--orange);animation:spin 0.9s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}
        .ltxt{font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:var(--cyan);letter-spacing:3px;animation:blink 1.2s step-end infinite;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.15}}

        /* RESULTS LAYOUT */
        .rw{width:100%;max-width:1160px;margin-top:36px;display:none;}
        .ri{display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start;}
        @media(max-width:820px){.ri{grid-template-columns:1fr;}}

        /* PANEL HEADERS */
        .ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
        .pl{font-family:'Orbitron',monospace;font-size:0.58rem;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;}
        .pm{font-family:'Share Tech Mono',monospace;font-size:0.66rem;color:var(--dim);}
        .pm b{color:var(--orange);}

        /* WEB RESULTS */
        .rg{display:grid;grid-template-columns:1fr;gap:9px;}
        .sdiv{font-family:'Share Tech Mono',monospace;font-size:0.6rem;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin:14px 0 7px;display:flex;align-items:center;gap:10px;}
        .sdiv::after{content:'';flex:1;height:1px;background:var(--border);}

        /* CARDS */
        .card{background:var(--panel);border:1px solid var(--border);border-left:3px solid var(--cyan);border-radius:0 4px 4px 0;padding:14px 17px;transition:all 0.2s;position:relative;overflow:hidden;animation:cs 0.3s ease forwards;opacity:0;transform:translateX(-8px);}
        @keyframes cs{to{opacity:1;transform:translateX(0)}}
        .card.prio{border-left-color:var(--orange);background:rgba(255,107,53,0.03);}
        .card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--cyan),transparent 55%);opacity:0.22;}
        .card.prio::before{background:linear-gradient(90deg,var(--orange),transparent 55%);}
        .card:hover{transform:translateX(4px);background:var(--panel-b);box-shadow:0 4px 22px rgba(0,0,0,0.35);}
        .ct{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:4px;}
        .ctitle{font-family:'Exo 2',sans-serif;font-weight:600;font-size:0.95rem;color:var(--cyan);text-decoration:none;line-height:1.3;flex:1;transition:color 0.2s;}
        .card.prio .ctitle{color:var(--orange);}
        .ctitle:hover{color:#fff;}
        .cbdg{font-family:'Share Tech Mono',monospace;font-size:0.48rem;letter-spacing:1.5px;padding:2px 6px;border-radius:2px;flex-shrink:0;text-transform:uppercase;margin-top:3px;}
        .cb-l{color:var(--orange);border:1px solid rgba(255,107,53,0.4);background:rgba(255,107,53,0.08);}
        .cb-w{color:#a0c4ff;border:1px solid rgba(160,196,255,0.3);background:rgba(160,196,255,0.05);}
        .cb-s{color:var(--cyan);border:1px solid rgba(0,229,255,0.3);background:rgba(0,229,255,0.05);}
        .curl{font-family:'Share Tech Mono',monospace;font-size:0.64rem;color:var(--dim);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .ud{color:rgba(0,229,255,0.5);}
        .card.prio .ud{color:rgba(255,107,53,0.6);}
        .csnip{font-size:0.85rem;color:var(--text);line-height:1.6;opacity:0.8;}

        /* ── IMAGE PANEL ── */
        .img-panel{position:sticky;top:20px;}
        .img-panel .pl{color:var(--purple);}
        .img-panel .ph{border-color:rgba(192,132,252,0.2);}
        .img-panel .pm b{color:var(--purple);}

        .ig{display:grid;grid-template-columns:1fr 1fr;gap:7px;}

        .ic{position:relative;aspect-ratio:4/3;overflow:hidden;border-radius:3px;border:1px solid rgba(192,132,252,0.18);background:rgba(192,132,252,0.04);cursor:pointer;transition:all 0.25s;animation:cs 0.35s ease forwards;opacity:0;}
        .ic:hover{border-color:rgba(192,132,252,0.6);transform:scale(1.03);z-index:5;box-shadow:0 8px 28px rgba(0,0,0,0.65);}
        .ic img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.35s;opacity:0;}
        .ic img.ok{opacity:1;}
        .ic .ov{position:absolute;bottom:0;left:0;right:0;padding:5px 7px;background:linear-gradient(transparent,rgba(0,0,0,0.88));font-family:'Share Tech Mono',monospace;font-size:0.5rem;color:#ccc;letter-spacing:0.5px;opacity:0;transition:opacity 0.2s;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .ic:hover .ov{opacity:1;}
        .ic .ibdg{position:absolute;top:4px;right:4px;font-family:'Share Tech Mono',monospace;font-size:0.42rem;letter-spacing:1px;padding:2px 5px;background:rgba(0,0,0,0.72);border:1px solid rgba(192,132,252,0.4);border-radius:2px;color:var(--purple);text-transform:uppercase;}

        /* shimmer */
        .ic.shim::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(192,132,252,0.04) 25%,rgba(192,132,252,0.1) 50%,rgba(192,132,252,0.04) 75%);background-size:200% 100%;animation:sh 1.4s infinite;}
        @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

        /* source label under image grid */
        .img-src-note{font-family:'Share Tech Mono',monospace;font-size:0.56rem;color:var(--dim);text-align:center;margin-top:8px;letter-spacing:1px;}
        .img-src-note span{color:var(--purple);}

        /* LOAD MORE */
        .more-btn{font-family:'Share Tech Mono',monospace;font-size:0.58rem;letter-spacing:2px;color:var(--dim);text-align:center;margin-top:9px;padding:8px;border:1px solid var(--border);border-radius:2px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;display:none;}
        .more-btn:hover{color:var(--purple);border-color:rgba(192,132,252,0.4);background:rgba(192,132,252,0.04);}

        /* LIGHTBOX */
        .lb{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.93);backdrop-filter:blur(14px);align-items:center;justify-content:center;flex-direction:column;gap:14px;padding:20px;}
        .lb.open{display:flex;}
        .lb-img{max-width:90vw;max-height:76vh;object-fit:contain;border:1px solid rgba(192,132,252,0.3);border-radius:4px;box-shadow:0 0 60px rgba(0,0,0,0.8);}
        .lb-meta{font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:#ccc;letter-spacing:1px;text-align:center;max-width:70vw;}
        .lb-meta a{color:var(--purple);text-decoration:none;}
        .lb-meta a:hover{color:#fff;}
        .lb-x{position:fixed;top:18px;right:22px;font-size:1.3rem;color:var(--dim);cursor:pointer;transition:color 0.2s;z-index:10001;font-family:monospace;}
        .lb-x:hover{color:#fff;}
        .lb-nav{display:flex;gap:18px;margin-top:4px;}
        .lb-nav button{font-family:'Share Tech Mono',monospace;font-size:0.63rem;letter-spacing:2px;padding:6px 16px;border:1px solid var(--border);border-radius:2px;background:transparent;color:var(--dim);cursor:pointer;transition:all 0.2s;text-transform:uppercase;}
        .lb-nav button:hover{color:var(--cyan);border-color:var(--cyan);}

        /* NO RESULTS */
        .nr{text-align:center;padding:55px 20px;}
        .nr-code{font-family:'Orbitron',monospace;font-size:2.8rem;color:var(--border);margin-bottom:10px;}
        .nr-msg{font-family:'Share Tech Mono',monospace;color:var(--dim);font-size:0.78rem;letter-spacing:2px;}

        .footer{margin-top:60px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:0.58rem;color:var(--dim);letter-spacing:2px;border-top:1px solid var(--border);width:90%;max-width:960px;padding-top:18px;}
        .footer span{color:var(--orange);}
        .iframe-warn{display:none;width:100%;max-width:700px;margin-top:14px;padding:14px 18px;border:1px solid rgba(255,107,53,0.5);border-left:3px solid var(--orange);border-radius:0 4px 4px 0;background:rgba(255,107,53,0.06);font-family:'Share Tech Mono',monospace;font-size:0.68rem;color:var(--orange);letter-spacing:1px;line-height:1.8;}
        .iframe-warn .iw-title{font-family:'Orbitron',monospace;font-size:0.62rem;letter-spacing:2px;margin-bottom:8px;}
        .iframe-warn .iw-dim{color:var(--dim);margin-top:6px;font-size:0.61rem;}

        @media(max-width:520px){.hud-r,.pfx{display:none}.logo-main{font-size:2.4rem}}
    </style>
</head>
<body>
<canvas id="sc"></canvas>
<div class="cnr tl"></div><div class="cnr br"></div>

<!-- LIGHTBOX -->
<div class="lb" id="lb">
    <div class="lb-x" id="lb-x">✕</div>
    <img class="lb-img" id="lb-img" src="" alt="">
    <div class="lb-meta" id="lb-meta"></div>
    <div class="lb-nav">
        <button onclick="lbNav(-1)">◀ PREV</button>
        <button onclick="lbNav(1)">NEXT ▶</button>
    </div>
</div>

<div class="app">
    <div class="hud">
        <div class="hud-l">
            <div class="ind"><div class="dot g"></div>SYS ONLINE</div>
            <div class="ind"><div class="dot o"></div>MULTI-SOURCE LIVE</div>
        </div>
        <div class="hud-r"><span id="htime">--:--:-- UTC</span></div>
    </div>

    <div class="logo">
        <div class="logo-eye">DART MEADOW AEROSPACE</div>
        <div class="logo-main">DART ALLEY</div>
        <div class="logo-sub">Neural Search Engine</div>
        <div class="logo-line"></div>
        <div class="badges">
            <div class="badge orng"><span class="bdot"></span>DART PRIORITY</div>
            <div class="badge" id="b-local"><span class="bdot"></span>LOCAL INDEX</div>
            <div class="badge" id="b-wiki"><span class="bdot"></span>WIKIPEDIA</div>
            <div class="badge" id="b-srx"><span class="bdot"></span>WEB SEARCH</div>
            <div class="badge" id="b-img"><span class="bdot"></span>IMAGE SCAN</div>
        </div>
    </div>

    <div class="sw">
        <div class="sf">
            <div class="si">
                <span class="pfx">&gt;_</span>
                <input type="text" id="qi" placeholder="search anything across the Meadow..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <button class="bscan" id="sbtn" onclick="doSearch()">SCAN</button>
            </div>
        </div>
        <div class="frow">
            <button class="ft on-o" id="f-prio"  onclick="tF('prio', this)">◈ DART DOMAINS</button>
            <button class="ft on-c" id="f-local" onclick="tF('local',this)">◉ LOCAL DB</button>
            <button class="ft on-c" id="f-wiki"  onclick="tF('wiki', this)">◉ WIKIPEDIA</button>
            <button class="ft on-c" id="f-srx"   onclick="tF('srx',  this)">◉ WEB SEARCH</button>
            <button class="ft on-p" id="f-img"   onclick="tF('img',  this)">◈ IMAGE SCAN</button>
        </div>
        <div class="sbar" id="sbar"></div>
    </div>

    <!-- IFRAME / RESTRICTED CONTEXT WARNING -->
    <div class="iframe-warn" id="iframeWarn">
        <div class="iw-title">⚠ RESTRICTED NETWORK CONTEXT DETECTED</div>
        External API calls are blocked in this environment (Claude preview / sandboxed iframe).<br>
        Download the file and open it from your local server to enable live search.<br>
        <div class="iw-dim">→ Open: <strong>localhost:7700/dartalley.html</strong> in your browser directly</div>
    </div>

    <div class="lw" id="lw">
        <div class="radar"></div>
        <div class="ltxt" id="ltxt">SCANNING...</div>
    </div>

    <div class="rw" id="rw">
        <div class="ri">
            <!-- WEB PANEL -->
            <div>
                <div class="ph">
                    <div class="pl">// SIGNAL CAPTURE //</div>
                    <div class="pm"><b id="rc">0</b> PATHWAYS</div>
                </div>
                <div class="rg" id="rg"></div>
            </div>
            <!-- IMAGE PANEL -->
            <div class="img-panel" id="imgP" style="display:none;">
                <div class="ph">
                    <div class="pl">// IMAGE SCAN //</div>
                    <div class="pm"><b id="ic">0</b> SIGNALS</div>
                </div>
                <div class="ig" id="ig"></div>
                <div class="img-src-note">SOURCE: <span>WIKIPEDIA · WIKIMEDIA</span></div>
                <div class="more-btn" id="moreBtn" onclick="loadMore()">▼ LOAD MORE</div>
            </div>
        </div>
    </div>

    <div class="footer">DART ALLEY &nbsp;|&nbsp; <span>DART MEADOW AEROSPACE</span> &nbsp;|&nbsp; SEARX · WIKIPEDIA · WIKIMEDIA · LOCAL</div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
//  DART ALLEY v4
//  Web:    Searx public instances (JSON API, no proxy needed)
//  Images: Wikipedia page images + Wikimedia Commons (no proxy)
// ═══════════════════════════════════════════════════════════

// ── STARFIELD ─────────────────────────────────────────
(function(){
    const cv=document.getElementById('sc'),cx=cv.getContext('2d');let st=[];
    const rsz=()=>{cv.width=innerWidth;cv.height=innerHeight;};
    const init=()=>{st=[];for(let i=0;i<200;i++)st.push({x:Math.random()*cv.width,y:Math.random()*cv.height,r:Math.random()*1.4+0.2,a:Math.random(),spd:Math.random()*0.25+0.04,dr:(Math.random()-0.5)*0.07});};
    const draw=()=>{cx.clearRect(0,0,cv.width,cv.height);st.forEach(s=>{cx.beginPath();cx.arc(s.x,s.y,s.r,0,Math.PI*2);cx.fillStyle=`rgba(200,225,255,${s.a})`;cx.fill();s.a+=(Math.random()-0.5)*0.016;s.a=Math.max(0.04,Math.min(1,s.a));s.x+=s.dr;s.y-=s.spd;if(s.y<-2){s.y=cv.height+2;s.x=Math.random()*cv.width;}});requestAnimationFrame(draw);};
    window.addEventListener('resize',()=>{rsz();init();});rsz();init();draw();
})();

// ── CLOCK ─────────────────────────────────────────────
setInterval(()=>{document.getElementById('htime').textContent=new Date().toUTCString().split(' ')[4]+' UTC';},1000);

// ── IFRAME / SANDBOX DETECTION ────────────────────────
(function(){
    const isIframe = window.self !== window.top;
    const isRestricted = isIframe || window.location.protocol === 'blob:' || window.location.href.includes('claude.ai');
    if(isRestricted){
        document.getElementById('iframeWarn').style.display = 'block';
        console.warn('[DART] Running in restricted context — external fetches will be blocked. Use localhost directly.');
    }
})();
const F={prio:true,local:true,wiki:true,srx:true,img:true};
const DART=['dartmeadow.com','radicaldeepscale.com','drymeadow.com'];
let DB=[], allImgs=[], imgPage=0;
const IPP=12;
const stats={};

function tF(k,btn){
    F[k]=!F[k];
    const cls=k==='prio'?'on-o':k==='img'?'on-p':'on-c';
    btn.classList.toggle(cls,F[k]);
}
function setBadge(id,cls='cyan'){const b=document.getElementById(id);if(b){b.classList.add(cls);}}
function setStat(k,cls,msg){stats[k]={cls,msg};document.getElementById('sbar').innerHTML=Object.values(stats).map(s=>`<div class="s2 ${s.cls}">${s.msg}</div>`).join('');}

// ── LOAD LOCAL DB ─────────────────────────────────────
fetch('database.json')
    .then(r=>{if(!r.ok)throw new Error(r.status);return r.json();})
    .then(d=>{DB=Array.isArray(d)?d:[];setBadge('b-local');setStat('local','ok','LOCAL: '+DB.length);})
    .catch(()=>setStat('local','warn','LOCAL: unavailable'));

// ── DOM ───────────────────────────────────────────────
const qi=document.getElementById('qi'),lw=document.getElementById('lw'),
      ltxt=document.getElementById('ltxt'),rw=document.getElementById('rw'),
      rg=document.getElementById('rg'),rc=document.getElementById('rc'),
      ig=document.getElementById('ig'),ic=document.getElementById('ic'),
      sbtn=document.getElementById('sbtn'),
      imgP=document.getElementById('imgP'),
      moreBtn=document.getElementById('moreBtn');

qi.addEventListener('keypress',e=>{if(e.key==='Enter')doSearch();});

// ── MAIN SEARCH ───────────────────────────────────────
async function doSearch(){
    const q=qi.value.trim();if(!q)return;
    sbtn.disabled=true;
    rg.innerHTML='';ig.innerHTML='';allImgs=[];imgPage=0;
    rw.style.display='none';imgP.style.display='none';moreBtn.style.display='none';
    lw.style.display='flex';ltxt.textContent='INITIALIZING SCAN...';
    const all=[];

    // 1. DART priority local
    if(F.prio&&DB.length){
        const ql=q.toLowerCase();
        DB.filter(i=>DART.some(d=>(i.url||'').toLowerCase().includes(d))&&hit(i,ql))
          .forEach(h=>all.push({...h,_s:'prio'}));
    }
    // 2. Local non-DART
    if(F.local&&DB.length){
        const ql=q.toLowerCase();
        DB.filter(i=>!DART.some(d=>(i.url||'').toLowerCase().includes(d))&&hit(i,ql))
          .forEach(h=>all.push({...h,_s:'local'}));
    }
    // 3. Wikipedia text search
    if(F.wiki){
        ltxt.textContent='QUERYING WIKIPEDIA...';
        try{
            const wr=await wikiSearch(q);
            wr.forEach(r=>all.push({...r,_s:'wiki'}));
            setBadge('b-wiki');setStat('wiki','ok','WIKI: '+wr.length);
        }catch(e){setStat('wiki','warn','WIKI: timeout');}
    }
    // 4. Searx web search (JSON API, no proxy needed)
    if(F.srx){
        ltxt.textContent='SCANNING WEB...';
        try{
            const sr=await searxSearch(q);
            sr.forEach(r=>all.push({...r,_s:'srx'}));
            setBadge('b-srx');setStat('srx','ok','WEB: '+sr.length);
        }catch(e){
            setStat('srx','warn','WEB: '+e.message.slice(0,32));
            console.warn('[DART] searx:',e.message);
        }
    }

    // Deduplicate
    const seen=new Set();
    const final=all.filter(r=>{const k=(r.url||r.title||'').toLowerCase();if(seen.has(k))return false;seen.add(k);return true;});

    // 5. Images (parallel, non-blocking)
    if(F.img){ltxt.textContent='SCANNING IMAGES...';searchImages(q).catch(()=>{});}

    lw.style.display='none';sbtn.disabled=false;
    renderWeb(final,q);
    rw.style.display='block';
}

// ── WIKIPEDIA TEXT SEARCH ─────────────────────────────
async function wikiSearch(q){
    const url=`https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&utf8=&format=json&origin=*&srlimit=8&srprop=snippet`;
    const r=await ft(url,8000);const d=await r.json();
    return(d.query?.search||[]).map(i=>({
        title:i.title,
        url:`https://en.wikipedia.org/wiki/${encodeURIComponent(i.title.replace(/ /g,'_'))}`,
        desc:striptags(i.snippet)+'...'
    }));
}

// ── SEARX WEB SEARCH ──────────────────────────────────
// Public Searx/SearXNG instances with JSON API & CORS — tried in order
// Public SearXNG instances — all verified to have CORS + JSON API enabled
// List ordered by reliability. If one is down, the next is tried automatically.
const SEARX_INSTANCES = [
    'https://searx.be',
    'https://searxng.site',
    'https://search.sapti.me',
    'https://searx.tiekoetter.com',
    'https://search.bus-hit.me',
    'https://searx.work',
    'https://priv.au',
    'https://searx.ninja',
    'https://paulgo.io',
    'https://search.in.projectsegfau.lt'
];

async function searxSearch(q){
    const params=`?q=${encodeURIComponent(q)}&format=json&categories=general&engines=google,bing,brave,duckduckgo&language=en`;
    let lastErr='All instances failed';
    for(const host of SEARX_INSTANCES){
        try{
            const res=await ft(host+'/search'+params, 8000);
            if(!res.ok) continue;
            const ct=res.headers.get('content-type')||'';
            if(!ct.includes('json')) continue;
            const d=await res.json();
            const results=(d.results||[]).slice(0,14).map(r=>({
                title: r.title||'',
                url:   r.url||'',
                desc:  r.content||r.publishedDate||''
            })).filter(r=>r.title&&r.url);
            if(results.length>0){
                console.log(`[DART] Searx via ${host}: ${results.length} results`);
                return results;
            }
        }catch(e){lastErr=e.message;continue;}
    }
    throw new Error(lastErr);
}

// ── IMAGE SEARCH ──────────────────────────────────────
// Source 1: Wikipedia search with page images (reliable, direct CORS)
// Source 2: Wikimedia Commons file search (direct CORS)

async function searchImages(q){
    const imgs=[];

    // === SOURCE A: Wikipedia page images via generator search ===
    try{
        const url=`https://en.wikipedia.org/w/api.php?`+
            `action=query&generator=search&gsrsearch=${encodeURIComponent(q)}`+
            `&prop=pageimages&format=json&origin=*&pithumbsize=500&gsrlimit=20&pilimit=20`;
        const r=await ft(url,8000);const d=await r.json();
        const pages=Object.values(d.query?.pages||{});
        pages.forEach(p=>{
            if(p.thumbnail){
                imgs.push({
                    thumb: p.thumbnail.source,
                    full:  p.thumbnail.source.replace(/\/\d+px-/,'/800px-'),
                    title: p.title,
                    link:  `https://en.wikipedia.org/wiki/${encodeURIComponent((p.title||'').replace(/ /g,'_'))}`,
                    src:   'WIKIPEDIA'
                });
            }
        });
    }catch(e){console.warn('[DART] wiki images:',e.message);}

    // === SOURCE B: Wikimedia Commons search ===
    try{
        const surl=`https://commons.wikimedia.org/w/api.php?`+
            `action=query&list=search&srnamespace=6&srsearch=${encodeURIComponent(q)}`+
            `&format=json&origin=*&srlimit=20&srprop=`;
        const sr=await ft(surl,8000);const sd=await sr.json();
        const fileTitles=(sd.query?.search||[]).map(s=>s.title);

        if(fileTitles.length){
            // Batch fetch image info for all files
            const titlesParam=fileTitles.slice(0,16).map(t=>encodeURIComponent(t)).join('%7C');
            const iurl=`https://commons.wikimedia.org/w/api.php?`+
                `action=query&titles=${titlesParam}`+
                `&prop=imageinfo&iiprop=url&iiurlwidth=400&format=json&origin=*`;
            const ir=await ft(iurl,8000);const id2=await ir.json();
            const ipages=Object.values(id2.query?.pages||{});
            ipages.forEach(p=>{
                const ii=p.imageinfo?.[0];
                if(ii?.thumburl||ii?.url){
                    const title=(p.title||'').replace(/^File:/,'');
                    imgs.push({
                        thumb: ii.thumburl||ii.url,
                        full:  ii.url||ii.thumburl,
                        title: title,
                        link:  `https://commons.wikimedia.org/wiki/${encodeURIComponent(p.title||'')}`,
                        src:   'WIKIMEDIA'
                    });
                }
            });
        }
    }catch(e){console.warn('[DART] wikimedia images:',e.message);}

    // Deduplicate by thumbnail URL
    const seen=new Set();
    allImgs=imgs.filter(i=>{if(seen.has(i.thumb))return false;seen.add(i.thumb);return true;});

    if(allImgs.length){
        setBadge('b-img','purp');
        setStat('img','ok','IMG: '+allImgs.length+' found');
        renderImgs(0);
    } else {
        setStat('img','warn','IMG: no results');
    }
}

function renderImgs(page){
    const start=page*IPP;
    const slice=allImgs.slice(start,start+IPP);
    if(!slice.length)return;

    imgP.style.display='block';
    ic.textContent=allImgs.length;

    slice.forEach((img,i)=>{
        const card=document.createElement('div');
        card.className='ic shim';
        card.style.animationDelay=(i*70)+'ms';
        card.dataset.idx=String(start+i);
        card.innerHTML=`<img data-src="${esc(img.thumb)}" alt="${esc(img.title)}">
            <div class="ov">${esc(img.title)}</div>
            <div class="ibdg">${esc(img.src)}</div>`;
        card.onclick=()=>openLB(start+i);
        ig.appendChild(card);

        // Lazy load
        const el=card.querySelector('img');
        const obs=new IntersectionObserver(e=>{
            if(e[0].isIntersecting){
                el.src=el.dataset.src;
                el.onload=()=>{el.classList.add('ok');card.classList.remove('shim');};
                el.onerror=()=>{card.remove();};
                obs.disconnect();
            }
        },{rootMargin:'120px'});
        obs.observe(card);
    });

    imgPage=page;
    moreBtn.style.display=allImgs.length>(page+1)*IPP?'block':'none';
}
function loadMore(){renderImgs(imgPage+1);}

// ── LIGHTBOX ──────────────────────────────────────────
let lbI=0;
document.getElementById('lb-x').onclick=()=>closeLB();
document.getElementById('lb').onclick=e=>{if(e.target===document.getElementById('lb'))closeLB();};
function openLB(idx){
    lbI=idx;const img=allImgs[idx];if(!img)return;
    document.getElementById('lb-img').src=img.full||img.thumb;
    document.getElementById('lb-meta').innerHTML=
        `${esc(img.title)}<br><a href="${esc(img.link)}" target="_blank" rel="noopener">${esc(img.src)}</a>`;
    document.getElementById('lb').classList.add('open');
    document.body.style.overflow='hidden';
}
function closeLB(){document.getElementById('lb').classList.remove('open');document.body.style.overflow='';}
function lbNav(d){const n=lbI+d;if(n>=0&&n<allImgs.length)openLB(n);}
document.addEventListener('keydown',e=>{
    if(!document.getElementById('lb').classList.contains('open'))return;
    if(e.key==='Escape')closeLB();
    if(e.key==='ArrowRight')lbNav(1);
    if(e.key==='ArrowLeft')lbNav(-1);
});

// ── RENDER WEB RESULTS ────────────────────────────────
function renderWeb(results,q){
    rc.textContent=results.length;
    if(!results.length){
        rg.innerHTML=`<div class="nr"><div class="nr-code">404</div><div class="nr-msg">NO PATHWAYS FOR &ldquo;${esc(q)}&rdquo;</div></div>`;
        return;
    }
    const groups={prio:[],local:[],wiki:[],srx:[]};
    results.forEach(r=>(groups[r._s]||groups.srx).push(r));
    const labels={prio:'◈ DART MEADOW — PRIORITY',local:'◉ LOCAL NEURAL INDEX',wiki:'◉ WIKIPEDIA LIVE FEED',srx:'◉ LIVE WEB RESULTS'};
    let delay=0;
    Object.entries(groups).forEach(([src,items])=>{
        if(!items.length)return;
        const d=document.createElement('div');d.className='sdiv';d.textContent=labels[src];rg.appendChild(d);
        items.forEach(item=>{delay+=50;rg.appendChild(mkCard(item,delay));});
    });
}

function mkCard(item,delay){
    const c=document.createElement('div');
    c.className='card'+(item._s==='prio'?' prio':'');
    c.style.animationDelay=delay+'ms';
    const bc={prio:'cb-l',local:'cb-l',wiki:'cb-w',srx:'cb-s'}[item._s]||'cb-s';
    const bl={prio:'DART',local:'LOCAL',wiki:'WIKI',srx:'WEB'}[item._s]||'WEB';
    const dm=getDom(item.url||'');
    const path=(item.url||'').replace(/^https?:\/\//,'').replace(/^[^\/]*/,'');
    c.innerHTML=`<div class="ct"><a href="${esc(item.url||'#')}" class="ctitle" target="_blank" rel="noopener">${esc(item.title||'Untitled')}</a><span class="cbdg ${bc}">${bl}</span></div><div class="curl"><span class="ud">${esc(dm)}</span>${esc(path)}</div><div class="csnip">${esc(item.desc||'No signal.')}</div>`;
    return c;
}

// ── UTILS ─────────────────────────────────────────────
function hit(item,ql){return(item.title||'').toLowerCase().includes(ql)||(item.desc||'').toLowerCase().includes(ql)||(item.tags||[]).some(t=>t.toLowerCase().includes(ql));}
function ft(url,ms){return Promise.race([fetch(url),new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);}
function striptags(s){return s.replace(/<[^>]+>/g,'').replace(/&quot;/g,'"').replace(/&amp;/g,'&').replace(/&#(\d+);/g,(_,n)=>String.fromCharCode(n));}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function getDom(u){try{return new URL(u).hostname;}catch{return u;}}
</script>
</body>
</html>
