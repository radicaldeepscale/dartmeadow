<!DOCTYPE html>
<html lang="en">
<head>
      <meta name="description" content="DART Meadow | Aerospace Tooling and Engineering">
<!-- Favicon block: ensures compatibility across all devices -->

<link rel="icon" href="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/static/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/static/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/static/favicon.ico">
      

<!-- Link to your RSS/Web Feed for Chrome's "Follow" feature -->
<link rel="alternate" type="application/rss+xml" title="DART Meadow &amp; Research and Development" href="/feed.xml">
  
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>DART Meadow</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r132/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
<style>
/* =================================================================
   THEME DEFINITION & GENERAL STYLES
   Inspired by the Audio Visualizer UI
   ================================================================= */
    :root {
      --theme-primary: #47c4f1; /* Bright teal/cyan for accents */
      --theme-primary-glow: rgba(71, 196, 241, 0.5);
      --theme-text: #E0F4FF; /* Light blueish-white text */
      --theme-panel-bg: rgba(30, 45, 57, 0.85); /* Dark, semi-transparent panel background */
      --theme-panel-border: #47c4f1;
      --theme-input-bg: #0e1b22; /* Very dark background for inputs */
      --theme-input-border: #4d5e6a;
      --theme-button-text-dark: #1e2d39;
      --theme-disabled-color: #778c9b;
    }

   /* full‐screen video behind everything */
    #bgvid {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: -10;
      pointer-events: none;
    }

    html, body {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  font-family: 'Segoe UI', sans-serif;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  overflow-y: auto;
  background-color: transparent; /* Changed from #000 */
  color: var(--theme-text);
}

    body > * {
      z-index: 1;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 100%;
      padding: 20px;
      border-radius: 10px;
      color: white;
      background: transparent !important;
    }

/* =================================================================
   PRIVACY MODAL STYLING
   ================================================================= */
    #privacyModal {
      position: fixed;
      top: 0; /* Changed from 30px to 0 for full-screen feel */
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5); /* Added a slight backdrop overlay */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100; /* Ensure it's on top */
      padding: 20px;
      overflow: auto;
    }

    .modal-content {
      max-height: 90vh;
      max-width: 700px;
      background: var(--theme-panel-bg);
      border: 1px solid var(--theme-panel-border);
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px var(--theme-primary-glow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
    }

    .modal-header {
      background: transparent;
      color: var(--theme-text);
      padding: 16px 24px;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid var(--theme-panel-border);
    }

    .modal-body {
      color: var(--theme-text);
      padding: 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    #policyContent {
      height: 180px;
      max-height: 35vh;
      overflow-y: auto;
      background: var(--theme-input-bg);
      border: 1px solid var(--theme-input-border);
      border-radius: 8px;
      padding: 14px;
      font-size: 0.95rem;
      line-height: 1.5;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
      flex-shrink: 0;
    }
    #policyContent a { color: var(--theme-primary); }
    #policyContent a:hover { color: var(--theme-text); }


    .modal-body em {
      font-size: 0.85rem;
      color: var(--theme-disabled-color);
      text-align: center;
    }

    .modal-body input[type="text"],
    .modal-body input[type="email"],
    .modal-body input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border: 1px solid var(--theme-input-border);
      border-radius: 6px;
      font-size: 0.95rem;
      background-color: var(--theme-input-bg);
      color: var(--theme-text);
      transition: all 0.3s ease;
    }
    .modal-body input:disabled {
        opacity: 0.5;
    }
    .modal-body input:focus {
        border-color: var(--theme-primary);
        box-shadow: 0 0 8px var(--theme-primary-glow);
        outline: none;
    }

    .modal-body label {
      color: var(--theme-disabled-color);
      display: block;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .modal-footer {
      padding: 16px 24px;
      background: transparent;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid var(--theme-panel-border);
    }

    .modal-footer button {
      padding: 8px 18px;
      border: 1px solid var(--theme-disabled-color);
      border-radius: 6px;
      background: transparent;
      color: var(--theme-disabled-color);
      font-weight: 500;
      cursor: not-allowed;
      transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .modal-footer button.enabled {
      border-color: var(--theme-primary);
      color: var(--theme-primary);
      cursor: pointer;
    }
    .modal-footer button.enabled:hover {
      background: var(--theme-primary);
      color: var(--theme-button-text-dark);
      box-shadow: 0 0 10px var(--theme-primary-glow);
    }

/* =================================================================
   SIDE MENU STYLING
   ================================================================= */
    #userMenuDropdown {
      display: none;
      position: fixed;
      top: 85px;
      left: 10px;
      width: 60vw;
      max-width: 215px;
      max-height: 80vh;
      
      background: var(--theme-panel-bg);
      border: 1px solid var(--theme-panel-border);
      color: var(--theme-text);
      padding: 12px;
      border-radius: 10px;
      
      overflow-y: auto;
      overflow-x: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5), 0 0 15px var(--theme-primary-glow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      
      display: flex; /* Kept from original to ensure layout */
      flex-direction: column;
      pointer-events: auto;
      touch-action: manipulation;
    }

    #userMenuDropdown p {
        margin: 2px 0;
    }

    #userMenuDropdown button,
    .menu-button { /* A new class for all menu buttons */
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--theme-input-border);
        color: var(--theme-text);
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        margin: 4px 0;
        text-align: left;
        transition: all 0.2s ease-in-out;
    }

    #userMenuDropdown button:hover,
    .menu-button:hover {
        background: var(--theme-primary);
        border-color: var(--theme-primary);
        color: var(--theme-button-text-dark);
        transform: translateX(5px);
    }
    
    /* Specific overrides */
    #userMenuDropdown #accountSettingsBtn { background: rgba(0,0,0,0.2); }
    #userMenuDropdown button[onclick="logout()"] { border-color: #f1476f; color: #f1476f; }
    #userMenuDropdown button[onclick="logout()"]:hover { background: #f1476f; border-color: #f1476f; color: #fff; }
    #userMenuDropdown button[onclick="deleteAccount()"] { margin-top: 12px; }

    #accountSettingsSection {
      display: none;
      margin-top: 8px;
      border-top: 1px solid var(--theme-input-border);
      padding-top: 8px;
    }
    #accountSettingsSection h4 { color: var(--theme-primary); margin: 4px 0; }
    #accountSettingsSection label { color: var(--theme-disabled-color); }
    #accountSettingsSection input {
        width: 100%;
        padding: 6px;
        margin-top: 2px;
        background-color: var(--theme-input-bg);
        border: 1px solid var(--theme-input-border);
        border-radius: 4px;
        color: var(--theme-text);
    }
    #accountSettingsSection button {
        background: #28a745;
        border: 1px solid #28a745;
        text-align: center;
    }
    #accountSettingsSection button:hover {
        background: #218838;
        border-color: #1e7e34;
        color: #fff;
    }

/* =================================================================
   MAIN PAGE CONTENT & FORMS STYLING
   ================================================================= */
    
    /* General Button Style for Main Page */
    #startInstanceBtn,
    #interactiveElements button {
        background: transparent;
        color: var(--theme-primary);
        border: 1px solid var(--theme-primary);
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    #startInstanceBtn:hover,
    #interactiveElements button:hover {
      background: var(--theme-primary);
      color: var(--theme-button-text-dark);
      box-shadow: 0 0 15px var(--theme-primary-glow);
    }

    /* Form Container Styling */
    #interactiveElements .container {
        width: 100%;
        background: var(--theme-panel-bg) !important;
        border: 1px solid var(--theme-panel-border);
        padding: 25px;
        border-radius: 8px;
        margin-top: 20px;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }

    #interactiveElements h4 {
        color: var(--theme-primary);
        font-weight: bold;
        text-align: center;
        margin-bottom: 15px;
    }
    
    #interactiveElements label {
      margin-right: 10px;
    }

    /* Main page inputs and textareas */
    #userInput, #algebraicValue,
    textarea#responseField,
    textarea#calculationResult {
      padding: 10px;
      border-radius: 5px;
      background-color: var(--theme-input-bg);
      border: 1px solid var(--theme-input-border);
      color: var(--theme-text);
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    #userInput:focus, #algebraicValue:focus,
    textarea#responseField:focus,
    textarea#calculationResult:focus {
        border-color: var(--theme-primary);
        box-shadow: 0 0 8px var(--theme-primary-glow);
        outline: none;
    }

    textarea#responseField,
    textarea#calculationResult {
      width: 100%; /* Changed from 80% to fit new container */
      height: 150px;
      margin-top: 20px;
    }

    #userInputForm, #algebraicValueForm {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }


/* =================================================================
   MISC & LEGACY STYLES (Minor adjustments)
   ================================================================= */
    h6 { color: white; margin-top: 10px; }
    h2 { color: white; font-weight: bold; }
    
    #canvasContainer {
      position: relative;
      width: 100%;
      max-width: 875px;
      height: auto;
      aspect-ratio: 1 / 1;
      margin-top: 50px;
      background: transparent;
    }
    #canvasContainer canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      max-width: 100%;
      --bs-gutter-x: 0;
    }
    
    .buttonContainer,
    .buttonContainer2 {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      width: 100%;
    }

    #chatContainer {
      display: none;
      flex-direction: column;
      width: 875px;
      padding-top: 50px;
      background: transparent !important;
    }
    #chat-header { text-align: center; margin-bottom: 30px; }
    #chat-header .chat-logo { width: 175px; object-fit: contain; }
    #messageWindow {
      height: 300px; border: 1px solid var(--theme-input-border); padding: 8px;
      overflow-y: auto; background: var(--theme-input-bg); width: 80%; border-radius: 5px;
    }
    #messageWindow p, #messageWindow span { color: var(--theme-text) !important; }
    .buttonContainer.chat { margin-top: 8px; gap: 8px; }
    .buttonContainer.chat input {
      width: 400px; padding: 8px; border-radius: 5px;
      background-color: var(--theme-input-bg); border: 1px solid var(--theme-input-border); color: var(--theme-text);
    }
    .buttonContainer.chat button {
      background-color: transparent; color: var(--theme-primary); border: 1px solid var(--theme-primary);
      padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;
    }
    .buttonContainer.chat button:hover { background-color: var(--theme-primary); color: var(--theme-button-text-dark); }

    label { margin: 8px; }

    #floatingMenuIcon {
      pointer-events: auto; touch-action: manipulation;
      position: fixed; top: 0; left: 0; margin: 25px;
    }
    #header {
      position: fixed; top: 0; left: 0; width: 100%; height: 60px;
      background-color: transparent; display: flex; align-items: center; justify-content: center; z-index: 3;
    }
    .avatar-placeholder {
      width: 150px; height: 150px; margin: 0 auto 10px; border-radius: 50%;
      overflow: hidden; position: relative; cursor: pointer; border: 2px solid var(--theme-primary);
    flex-shrink: 0;
    }
    .avatar-placeholder img { width: 100%; height: 100%; object-fit: cover; }

    .avatar-selection-popup {
      display: none; position: absolute; top: 100px; left: 235px;
      background: var(--theme-panel-bg); padding: 8px; border-radius: 6px;
      border: 1px solid var(--theme-panel-border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;
      grid-template-columns: repeat(8, 50px); grid-auto-rows: 50px; gap: 8px;
      width: calc((50px + 8px) * 8 - 8px); height: calc((50px + 8px) * 8 - 8px);
      overflow: auto;
    }
    .avatar-selection-popup.active { display: grid !important; }
    .avatar-selection-popup img {
      width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
      cursor: pointer; transition: transform .15s;
    }
    .avatar-selection-popup img:hover { transform: scale(1.2); }
    
    /* Deprecated selectors from old buttons */
    #userLoginToggle, #ashCanvas, #btnleatr, #btnleav, #btnltrproto, #btnide, #btnmn, #dartmeadow {
      /* All styling is now handled by the #userMenuDropdown button rule */
    }
/* Add this inside your <style> tag */
#merchandiseBtn {
    display: flex; /* Use flexbox for centering */
    flex-direction: column;
    align-items: center; /* Vertically align items */
    justify-content: center; /* Horizontally align items */
    text-align: center; /* Ensure text is centered if it wraps */
    padding: 10px 0; /* Adjust padding as needed */
    height: auto; /* Allow height to adjust to the image + padding */
}

#merchandiseBtn img {
    /* Keep the user's requested size */
    width: 70px;
    height: 100px;
    /* Keep margin-right to separate from text */
    margin-right: 8px;
    /* Remove vertical-align as flexbox handles alignment */
    vertical-align: initial; /* or just remove the line */
}

#merchandiseBtn span {
    /* Basic styling for the text */
    display: block; /* Ensure text is on its own line if needed, though flex will put it next to image */
    flex-shrink: 0; /* Prevent text from shrinking */
}
    .speaker-button {
      padding-top: 25px; background-color: transparent;
      border: none; cursor: pointer; outline: none;
    }
    .speaker-button img { background-color: transparent; width: 50px; height: 50px; }
</style>
</head>

<body>


    <!-- full‐screen video background -->
 <video id="bgvid" autoplay muted loop playsinline>
  <source src="https://raw.githubusercontent.com/radicaldeepscale/dartmeadow/tree/main/static/dmbg.mp4" type="video/mp4">
</video>


  <!-- Privacy & Consent Modal -->
  <div id="privacyModal">
    <div class="modal-content">
      <div class="modal-header">
        You must agree to DART Meadow's Privacy Policy.
      </div>
      <div class="modal-body">

        <!-- Scrollable Privacy Policy -->
        <div id="policyContent">
              <!-- 🍪 Cookie/Storage blurb -->
    <p class="cookie‑blurb">
      We’ll store your acceptance in <strong>localStorage</strong> (like a cookie) so 
      you won’t see this again on this device/browser.
    </p>
          <h3>DART Meadow Privacy Policy and License</h3>
          <p><strong>Where As Such:</strong></p>
          <p>DART Meadow LLC. | Radical Deepscale LLC. Privacy Policy and Licensing</p>
          <p><strong>Information obtained:</strong><br>
            Input provided by the Visitor or prior interactions in our network will be respectfully
            mutual and private where such is engaged. Upon interacting with the network any visitor
            agrees to our (yourself, your group or groups as a whole) duty(ies) in ethics for liability
            outside our network.
          </p>
          <p><strong>With as such, Documentation or Assets publicly shared by our Network are
            welcomed to be copied and distributed but not modified without consent so as long as you
            provide this attached License Policy with the Documents or Assets.</strong>
          </p>
          <p>Commercial distributions are fine only where upon exercising so the License Policy is
            attached to Documents or Assets then only distributed as highlighted reference. When
            you exercise modification you must seek consent.
          </p>
          <p><a href="https://leadedge.wixsite.com/dartmeadow/privacy-policy" target="_blank">
            Full policy on dartmeadow.com</a>
          </p>
          <!-- sentinel at bottom -->
          <div id="policyEnd" style="width:100%;height:5px;"></div>
        </div>

        <p><em>Scroll to the bottom of the policy to enable the buttons</em></p>

        <!-- Create Account Form -->
        <div id="signupSection">
          <h5>Create Account</h5>
          <div class="row">
            <div class="col">
              <label>Username
                <input id="signupUsername" type="text" placeholder="Pick a username" disabled>
              </label>
            </div>
            <div class="col">
              <label>Name
                <input id="signupName" type="text" placeholder="Your name" disabled>
              </label>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col">
              <label>Email
                <input id="signupEmail" type="email" placeholder="you@example.com" disabled>
              </label>
            </div>
            <div class="col">
              <label>Password
                <input id="signupPassword" type="password" placeholder="Pick a password" disabled>
              </label>
            </div>
          </div>
        </div>

        <!-- Login Form -->
        <div id="loginSection" class="mt-4">
          <h5>Login</h5>
          <div class="row">
            <div class="col">
              <label>Username
                <input id="loginUsername" type="text" placeholder="Your username" disabled>
              </label>
            </div>
            <div class="col">
              <label>Password
                <input id="loginPassword" type="password" placeholder="Your password" disabled>
              </label>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button id="createBtn" disabled>Create Account</button>
        <button id="loginBtn" disabled>Login</button>
        <button id="continueBtn" disabled>Continue as Guest</button>
      </div>
    </div>
  </div>
<div id="header">
  <!-- avatar‐as menu‐icon -->
  <img id="floatingMenuIcon" src="https://raw.githubusercontent.com/radicaldeepscale/dartmeadow/refs/heads/main/static/dmlogo%20(20250726055056)%20(20250918121801).png"
  alt="User Avatar"
  style="width:50px;height:50px;cursor:pointer; border-radius:50%; object-fit:cover;"
/>

<!-- avatar grid popup -->
<div id="avatarSelectionPopup" class="avatar-selection-popup"></div>

   
    <div id="userMenuDropdown">
      <div class="avatar-placeholder" id="avatarPlaceholder">
        <img src="https://raw.githubusercontent.com/radicaldeepscale/dartmeadow/refs/heads/main/static/dmlogo%20(20250726055056)%20(20250918121801).png"
        id="userAvatar"
        alt="User Avatar"
 >
      </div>

      <!-- the popup — note it’s initially empty -->
      <div id="avatarSelectionPopup" class="avatar-selection-popup"></div>
      
  <p><strong id="menuName"></strong></p>

    <p><strong id="menuName"></strong></p>
    <p id="menuEmail" style="font-size:0.9em;"></p>
    
<!-- LOGIN / CREATE SECTION (hidden until “Log In” clicked) -->
<button id="userLoginToggle">
  Credentials
</button>





<button
  id="btnarview"
  onclick="location.href='https://radicaldeepscale.com/ar.html'"
>
  DART View
</button>






<button
  id="btnmn"
  onclick="location.href='https://radicaldeepscale.com/mn.html'"
>
  Mantis Navigation
      </button>
      
      <button
  id="btnalt"
  onclick="location.href='https://radicaldeepscale.com/altitude.html'"
>
  Altitude Calculators
      </button>
      

    <!-- Add inside <div id="userMenuDropdown"> -->
<button id="accountSettingsBtn">Account Settings</button>

<div id="accountSettingsSection">
  <!-- Change Email -->
  <h4>Change Email</h4>
  <label>Current Password:
    <input type="password" id="currentEmailPwd" placeholder="Enter current password" />
  </label>
  <label>New Email:
    <input type="email" id="newEmail" placeholder="Enter new email" />
  </label>
  
  <button onclick="changeEmail()">Change Email</button>
  <hr style="border-color:#555; margin:8px 0;" />
  <!-- Change Password -->
  <h4>Change Password</h4>
  <label>Current Password:
    <input type="password" id="currentPwd" placeholder="Enter current password" />
  </label>
  <label>New Password:
    <input type="password" id="newPwd" placeholder="Enter new password" />
  </label>
  
  <button onclick="changePassword()">Change Password</button>
</div>
<br>

<!-- Add this inside the <div id="userMenuDropdown"> -->
<!-- Just above the 'Log Out' button -->

<button
  id="merchandiseBtn"
  class="menu-button"
  onclick="location.href='https://leadedge.wixsite.com/dartmeadow/skyboard'"
> <!-- The closing > for the opening tag should be HERE -->
  <!-- Content goes inside the button -->
  <img src="https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/static/leatrshirt.png" alt="Merchandise Icon" style="width: 70px; height: 100px; margin-right: 8px;">
  <span>Skyboard Shop</span>
</button> 
<br>

    <button onclick="logout()">Log Out</button>
    <br>
    <button onclick="deleteAccount()">Delete Account</button>
    <br>
    
    <button
  id="linkedin"
  onclick="location.href='https://linkedin.com/comm/mynetwork/discovery-see-all?usecase=PEOPLE_FOLLOWS&followMember=dartmeadow'"
>
  LinkedIn: DM Studio
</button>
<br>

 <button
 id="dartmeadow"
 onclick="location.href='https://www.radicaldeepscale.com/'"
>
Radical Deepscale
</button>




</div>
<script>
  document.getElementById('floatingMenuIcon')
    .addEventListener('click', ()=>{
      let dd = document.getElementById('userMenuDropdown');
      // The display style is now handled in the stylesheet, this script just toggles it
      dd.style.display = dd.style.display==='flex' ? 'none':'flex';
  });
</script>
</div>
  
 <div class="DARTSound">
        <!-- Button to control audio -->
        <button id="mute" onClick="playPause()" class="speaker-button">
          <img id="speaker-icon" src="https://static.wixstatic.com/media/2451db_f3535dbdc10b4117a28832eeef15fa71~mv2.png" alt="Play">
          <audio id="backgroundMusic" src="https://static.wixstatic.com/mp3/2451db_3d232605a51744daaf4e8f0e6f8fb0a0.mp3" play loop></audio>
        </button>

        <script>
          const audioElement = document.getElementById('backgroundMusic');
          const speakerIcon = document.getElementById('speaker-icon');

          function playPause() {
            if (audioElement.paused) {
              audioElement.play();
              speakerIcon.src = "https://static.wixstatic.com/media/2451db_18a14b6ce43e4412bbe3edb353b6f399~mv2.png"; // Switch to pause icon
              speakerIcon.alt = "Pause";
            } else {
              audioElement.pause();
              speakerIcon.src = "https://static.wixstatic.com/media/2451db_f3535dbdc10b4117a28832eeef15fa71~mv2.png"; // Switch to play icon
              speakerIcon.alt = "Play";
            }
          }
        </script>
      </div>

  <!-- Main Chat -->
  <div id="chatContainer">
    <div class="container">
      <div id="chat-header">
        <img
          class="chat-logo"
          src="https://raw.githubusercontent.com/radicaldeepscale/dartmeadow/refs/heads/main/static/dmlogo%20(20250726055056)%20(20250918121801).png"
          alt="DART";
        />
      </div>

    </div>
  </div>

<script>
let GS_URL = ''; // declared early

// Grab the toggle and the modal
const userLoginToggle = document.getElementById('userLoginToggle');
const modal           = document.getElementById('privacyModal');

// When they click “Log In / Create Account”, we simply bring the modal back
userLoginToggle.addEventListener('click', () => {
  modal.style.display = 'flex';

  // If you have scroll‑to‑enable inside the modal, re‑start it:
  startScrollObserver();
});

let policyObserver; // define observer in a broader scope

function startScrollObserver() {
    const policy = document.getElementById('policyContent');
    const sentinel = document.getElementById('policyEnd');
    const formInputs = document.querySelectorAll('.modal-body input');
    const buttons = document.querySelectorAll('.modal-footer button');

    // Disconnect any previous observer to prevent multiple triggers
    if (policyObserver) {
        policyObserver.disconnect();
    }

    policyObserver = new IntersectionObserver((entries, obs) => {
        if (entries[0].isIntersecting) {
            formInputs.forEach(i => i.disabled = false);
            buttons.forEach(b => {
                b.disabled = false;
                b.classList.add('enabled');
            });
            obs.disconnect(); // Stop observing once enabled
        }
    }, {
        root: policy,
        threshold: 1.0
    });

    policyObserver.observe(sentinel);
}


// Self-invoking function for initial setup
;(function() {
  const modal = document.getElementById('privacyModal');
  const chat = document.getElementById('chatContainer');
  const continueBtn = document.getElementById('continueBtn');
  const createAccountBtn = document.getElementById('createBtn');
  const loginBtn = document.getElementById('loginBtn');
  
  // 1) On load, check if they’ve previously accepted
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('privacyAccepted') === 'true') {
      modal.style.display = 'none';
      chat.style.display  = 'flex';
      initUserMenuIfStored(); // your existing auto-login / avatar init
    } else {
      modal.style.display = 'flex'; // Show modal if not accepted
      startScrollObserver(); // Initialize the scroll observer
    }
  });

  function acceptPrivacy() {
    localStorage.setItem('privacyAccepted', 'true');
    modal.style.display = 'none';
    chat.style.display = 'flex';
  }

  // Hook into buttons that imply acceptance
  continueBtn.addEventListener('click', () => {
    if (!continueBtn.classList.contains('enabled')) return;
    acceptPrivacy();
  });
  
  // These functions will be defined later, but we can set up the acceptance part
  createAccountBtn.addEventListener('click', () => {
    if (createAccountBtn.classList.contains('enabled')) {
       // The actual account creation logic will handle success/failure
       // but we can pre-emptively set acceptance upon a valid click.
       // It's better to do it inside onUserReady after successful creation.
    }
  });
  
  loginBtn.addEventListener('click', () => {
     if (loginBtn.classList.contains('enabled')) {
       // Same as above, do it inside onUserReady after successful login.
     }
  });
  
})();

function onUserReady(u) {
  localStorage.setItem('privacyAccepted', 'true');
  saveUser(u);
  document.getElementById('privacyModal').style.display = 'none';
  document.getElementById('chatContainer').style.display = 'flex';
  document.getElementById('menuName').innerText = u.name;
  document.getElementById('menuEmail').innerText = u.email;
  // document.getElementById('floatingMenu').style.display = 'block'; // This ID does not exist
  // We manage the menu visibility with its own click listener.
}


function startUserInstance() {
  fetch('https://script.google.com/macros/s/AKfycbzthCAgveCNyw_Cp3WdzHQBbsMYiKHEIZiC9g-RKjaQb4f3tbjma29egU7Jgyyt3LdYFA/exec')
  .then(response => response.text())
  .then(sheetUrl => {
    
    document.getElementById('startInstanceBtn').style.display = 'none';
    document.getElementById('interactiveElements').style.display = 'block';
    alert("Your personal sheet instance is ready. Please proceed.");
  })
  .catch(error => console.error('Error:', error));
}

function submitUserInput(event) {
  event.preventDefault();
  var userInput = document.getElementById('userInput').value;
  var formData = new FormData();
  formData.append('encodetoAutumn', userInput);
  fetch('https://script.google.com/macros/s/AKfycbwKWaUL1hOF_bXITYJknZfynRTcAvTfb9HASZKs7X8mr6zmdfaStNYBeoMTtaTj1SnTRA/exec', {
    method: 'POST',
    body: formData,
  })
  .then(response => response.text())
  .then(text => {
    document.getElementById('responseField').value = text;
    document.getElementById('userInput').value = '';
    updateVisualization(); // Dynamically update visualization based on the response data
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('responseField').value = "Error processing request.";
  });
}

function submitAlgebraicValue(event) {
  event.preventDefault();
  var algebraicValue = document.getElementById('algebraicValue').value;
  var formData = new FormData();
  formData.append('algebraicValue', algebraicValue);
  fetch('https://script.google.com/macros/s/AKfycbzhRCS88J2s9HrV0HJjUp6_uebt5JJuYsD9GpfWVHkI09dbfRsgCDqLb8v4K_XjHBrY_A/exec', {
    method: 'POST',
    body: formData,
  })
  .then(response => response.text())
  .then(text => {
    document.getElementById('calculationResult').value = text;
    document.getElementById('algebraicValue').value = '';
    updateVisualization(); // Dynamically update visualization based on the response data
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('calculationResult').value = "Error processing request.";
  });
}

function downloadResponse() {
  var response = document.getElementById('responseField').value;
  var blob = new Blob([response], {type: "text/plain"});
  var anchor = document.createElement("a");
  anchor.download = "Autumn.ash";
  anchor.href = window.URL.createObjectURL(blob);
  anchor.style.display = "none";
  document.body.appendChild(anchor);
  anchor.click();
  document.body.removeChild(anchor);
}

function downloadAlgebraResponse() {
  var response = document.getElementById('calculationResult').value;
  var blob = new Blob([response], {type: "text/plain"});
  var anchor = document.createElement("a");
  anchor.download = "Element Algebra.ash";
  anchor.href = window.URL.createObjectURL(blob);
  anchor.style.display = "none";
  document.body.appendChild(anchor);
  anchor.click();
  document.body.removeChild(anchor);
}

// Three.js setup for dynamic node visualization with OrbitControls
let scene, camera, renderer, controls, nodes = [], lines = [];
let currentColor = new THREE.Color(Math.random(), Math.random(), Math.random());

function init() {
  const container = document.getElementById('canvasContainer');
  if (!container) return;

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.z = 100;

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('webglCanvas'), antialias: true, alpha: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  // No need to appendChild if canvas element is already in HTML

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.25;
  controls.enableZoom = true;

  const ambientLight = new THREE.AmbientLight(0x404040);
  scene.add(ambientLight);

  const pointLight = new THREE.PointLight(0xffffff, 1, 500);
  pointLight.position.set(10, 10, 10);
  scene.add(pointLight);

  createNodes(10); // Create initial nodes with fewer data points
  animate();

  // Handle resize
  window.addEventListener('resize', () => {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
  }, false);
}

function createNodes(count) {
  for (let i = 0; i < count; i++) {
    const phi = Math.acos(-1 + (2 * i) / count);
    const theta = Math.sqrt(count * Math.PI) * phi;

    const position = new THREE.Vector3(
      30 * Math.cos(theta) * Math.sin(phi),
      30 * Math.sin(theta) * Math.sin(phi),
      30 * Math.cos(phi)
    );
    const node = createNode(position, currentColor); // Initial color nodes
    nodes.push(node);
  }
  updateLines();
}

function createNode(position, color) {
  const geometry = new THREE.SphereGeometry(1, 32, 32);
  const material = new THREE.MeshBasicMaterial({
    color: color,
    transparent: true,
    opacity: 0.6
  });
  const node = new THREE.Mesh(geometry, material);

  const glowMaterial = new THREE.MeshBasicMaterial({
    color: color,
    transparent: true,
    opacity: 0.2
  });
  const glow = new THREE.Mesh(new THREE.SphereGeometry(1.2, 32, 32), glowMaterial);

  node.add(glow);
  node.position.copy(position);
  scene.add(node);
  return node;
}

function updateLines() {
  lines.forEach(line => scene.remove(line));
  lines = [];

  nodes.forEach((node, index) => {
    if (index > 0) {
      const previousNode = nodes[index - 1];
      const points = [];
      points.push(previousNode.position);
      points.push(node.position);

      const geometry = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(points), 20, 0.2, 8, false);
      const material = new THREE.MeshBasicMaterial({ color: currentColor }); // Lines matching node color
      const line = new THREE.Mesh(geometry, material);
      scene.add(line);
      lines.push(line);
    }
  });
}

function updateVisualization() {
  currentColor = new THREE.Color(Math.random(), Math.random(), Math.random()); // Randomize color
  nodes.forEach(node => {
    node.material.color.set(currentColor);
    node.children[0].material.color.set(currentColor);
  });
  updateLines();
}

function animate() {
  requestAnimationFrame(animate);
  if(controls) controls.update();
  const time = Date.now() * 0.001;

  nodes.forEach(node => {
    node.material.color.offsetHSL(0.0005, 0, 0);
    node.children[0].material.color.offsetHSL(0.0005, 0, 0);
  });
  if(renderer) renderer.render(scene, camera);
}

window.onload = init;
// Menu Begin 


// Environment Auto-Detect and GS_URL Setup

if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
  console.log('%cRunning in LOCALHOST mode', 'color: orange; font-weight: bold;');
  GS_URL = 'https://script.google.com/macros/s/AKfycbyky9F5m5qky4a8dLb1lZw3af3R7Z73Sig8-42DHiVKiirF5tcLImRAGdoAJugVsqsfcw/exec';
} else {
  console.log('%cRunning in PRODUCTION mode', 'color: deepskyblue; font-weight: bold;');
  GS_URL = 'https://script.google.com/macros/s/AKfycbyky9F5m5qky4a8dLb1lZw3af3R7Z73Sig8-42DHiVKiirF5tcLImRAGdoAJugVsqsfcw/exec';
}

// Session Storage Functions
function saveUser(u) {
  sessionStorage.setItem('user', JSON.stringify(u));
}
function getUser() {
  return JSON.parse(sessionStorage.getItem('user') || 'null');
}
function clearUser() {
  sessionStorage.removeItem('user');
}

// After Login/Create, Initialize UI - This function is now defined earlier


async function createAccount() {
  const btn = document.getElementById('createBtn');
  if (!btn.classList.contains('enabled')) {
    alert('Please scroll to the bottom of the Privacy Policy before proceeding.');
    return;
  }

  const form = new URLSearchParams({
    action: 'create',
    username: document.getElementById('signupUsername').value,
    name:     document.getElementById('signupName').value,
    email:    document.getElementById('signupEmail').value,
    password: document.getElementById('signupPassword').value
  });

  try {
    const res = await fetch(GS_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: form
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();

    if (j.ok) {
      showBanner(`✅ Account created for ${j.username}`, 'success');
      setTimeout(() => onUserReady(j), 1200);
    } else {
      alert(j.error || 'Account creation failed.');
    }
  } catch (err) {
    console.error('Fetch error:', err);
    alert('Connection failed. Check console.');
  }
}




async function login() {
  const btn = document.getElementById('loginBtn');
  if (!btn.classList.contains('enabled')) {
    alert('Please scroll to the bottom of the Privacy Policy before proceeding.');
    return;
  }

  const url = `${GS_URL}?action=login&username=${encodeURIComponent(document.getElementById('loginUsername').value)}&password=${encodeURIComponent(document.getElementById('loginPassword').value)}`;

  try {
    const res = await fetch(url);
    const j = await res.json();

    if (j.ok) {
      showBanner(`👋 Welcome back, ${j.name}`, 'info');
      setTimeout(() => onUserReady(j), 1000);
    } else {
      alert(j.error || 'Login failed.');
    }
  } catch (err) {
    console.error('Login error:', err);
    alert('Login connection failed.');
  }
}



// Delete Account
async function deleteAccount() {
  const u = getUser();
  if (!u || !u.username) return;
  const res = await fetch(`${GS_URL}?action=delete&username=${encodeURIComponent(u.username)}`);
  const j = await res.json();
  if (j.ok) {
    clearUser();
    alert('Account deleted successfully');
    window.location.reload();
  } else {
    alert(j.error || 'Account deletion failed.');
  }
}

// Logout
function logout() {
  clearUser();
  alert('Logged out successfully.');
  window.location.reload();
}

// Change Email
async function changeEmail() {
  const u = getUser();
  const form = new URLSearchParams({
    action: 'changeEmail',
    username: u.username,
    currentPassword: document.getElementById('currentEmailPwd').value,
    newEmail: document.getElementById('newEmail').value
  });

  const res = await fetch(GS_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: form
  });

  const j = await res.json();
  if (j.ok) {
    u.email = form.get('newEmail');
    saveUser(u);
    document.getElementById('menuEmail').innerText = u.email;
    alert('Email updated successfully.');
  } else {
    alert(j.error || 'Email change failed.');
  }
}

// Change Password
async function changePassword() {
  const u = getUser();
  const form = new URLSearchParams({
    action: 'changePassword',
    username: u.username,
    currentPassword: document.getElementById('currentPwd').value,
    newPassword: document.getElementById('newPwd').value
  });

  const res = await fetch(GS_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: form
  });

  const j = await res.json();
  if (j.ok) {
    alert('Password changed successfully.');
  } else {
    alert(j.error || 'Password change failed.');
  }
}

// Connect Buttons to Functions
document.getElementById('createBtn').onclick = createAccount;
document.getElementById('loginBtn').onclick = login;
document.getElementById('accountSettingsBtn').addEventListener('click', () => {
  const sec = document.getElementById('accountSettingsSection');
  sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
});

// Auto-login if already stored
function initUserMenuIfStored() {
    const u = getUser();
    if (u) {
        onUserReady(u);
    }
}
window.addEventListener('DOMContentLoaded', initUserMenuIfStored);

window.addEventListener('resize', () => {
  const menu = document.getElementById('userMenuDropdown');
  if (menu) {
    menu.style.maxHeight = `${window.innerHeight * 0.9}px`;
  }
});

function showBanner(message, type = 'info') {
  const banner = document.createElement('div');
  banner.textContent = message;
  banner.style.position = 'fixed';
  banner.style.top = '20px';
  banner.style.left = '50%';
  banner.style.transform = 'translateX(-50%)';
  banner.style.padding = '12px 24px';
  banner.style.borderRadius = '8px';
  banner.style.fontWeight = '600';
  banner.style.zIndex = 99999;
  banner.style.boxShadow = '0 2px 12px rgba(0,0,0,0.2)';
  banner.style.color = '#fff';

  if (type === 'success') banner.style.background = 'limegreen';
  else if (type === 'info') banner.style.background = 'deepskyblue';
  else banner.style.background = '#555';

  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 2500);
}


const avatarPlaceholder = document.getElementById('avatarPlaceholder');
const avatarPopup       = document.getElementById('avatarSelectionPopup');

const userAvatarImg     = document.getElementById('userAvatar');
const menuIcon          = document.getElementById('floatingMenuIcon');

const AVATAR_FILES = [
  'default.png',
  'defaultleatr.png',
  'arieldm.png',
  'ArielNeom.png',
  'dart.png',
  'autumn.jpg',
  'justin.png',
  'justinbackdrop.jpg',
  'darkeagle.png',
  'dartmeadowtree.png',
  'pinkpanther.png',
  'pinkpanthersharp.png',
  'radicaldeepscalehornet.png',
  'autumnhornet.png',
  'lec.png',
  'timburtonisland.png',
  'arielfire.png',
  'ArielWhite.png',
  'ArielEmerald.png',
  // …
];

function buildAvatarGrid() {
  avatarPopup.innerHTML = '';
  AVATAR_FILES.forEach(fn => {
    const img = document.createElement('img');
    img.src = `https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/static/avatars/${fn}`;      // <— correct static path
    img.title = fn;
    img.addEventListener('click', () => {
      document.getElementById('userAvatar').src        = img.src;
      document.getElementById('floatingMenuIcon').src  = img.src;
      sessionStorage.setItem('userAvatar', img.src);
      avatarPopup.classList.remove('active');
    });
    avatarPopup.appendChild(img);
  });
}

// 3) TOGGLE POPUP ON CLICK
avatarPlaceholder.addEventListener('click', () => {
    // This now targets the main popup container, not the grid itself.
    const popupGrid = document.querySelector('.avatar-selection-popup');
    if (popupGrid.classList.contains('active')) {
        popupGrid.classList.remove('active');
    } else {
        popupGrid.classList.add('active');
    }
});


window.addEventListener('DOMContentLoaded', () => {
  buildAvatarGrid();
  const saved = sessionStorage.getItem('userAvatar');
  if (saved) {
    document.getElementById('userAvatar').src       = saved;
    document.getElementById('floatingMenuIcon').src = saved;
  }
});


</script>
</body>
</html>
